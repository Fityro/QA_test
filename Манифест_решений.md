## АВТОМАТИЗИРОВАННАЯ СИСТЕМА РАЗВЕРТЫВАНИЯ

### Минимизация участия человека

Создана трехшаговая система автоматического развертывания расширения:

**ШАГ 1**: `vsce package --allow-missing-repository`
- **Назначение**: Создание .vsix пакета расширения
- **Автоматизация**: Упаковка всего кода в единый установочный файл
- **Результат**: Файл `training-catalog-examiner-0.0.1.vsix`

**ШАГ 2**: `code --uninstall-extension fityro.training-catalog-examiner`
- **Назначение**: Удаление предыдущей версии расширения
- **Автоматизация**: Очистка от старых версий перед установкой
- **Результат**: Чистая среда для новой установки

**ШАГ 3**: `code --install-extension training-catalog-examiner-0.0.1.vsix`
- **Назначение**: Установка новой версии из .vsix файла
- **Автоматизация**: Полная установка без ручного вмешательства
- **Результат**: Готовое к работе расширение

### Преимущества автоматизации

1. **Нулевое ручное вмешательство** после запуска команд
2. **Гарантированная чистота установки** (удаление перед установкой)
3. **Воспроизводимость** процесса развертывания
4. **Быстрое тестирование изменений** (весь цикл за секунды)

### Интеграция в процесс разработки

```bash
# Полный цикл обновления расширения
vsce package --allow-missing-repository
code --uninstall-extension fityro.training-catalog-examiner  
code --install-extension training-catalog-examiner-0.0.1.vsix
```

**ВАЖНО**: Эта система позволяет разработчику сосредоточиться на коде, а не на процессе развертывания.

## ПОШАГОВАЯ ИНСТРУКЦИЯ ДЛЯ ВОССОЗДАНИЯ

### ШАГ 1: Создание структуры проекта

1. Создать папку `app` в корне workspace
2. В папке `app` создать файлы:
   - `package.json` (манифест расширения)
   - `extension.ts` (основной код)
   - `tsconfig.json` (конфигурация TypeScript)

### ШАГ 2: Настройка package.json

**КРИТИЧЕСКИ ВАЖНО**: В package.json должны быть:

```json
{
  "contributes": {
    "viewsContainers": {
      "activitybar": [
        {
          "id": "examinerContainer",
          "title": "Training Examiner",
          "icon": "$(play)"
        }
      ]
    },
    "views": {
      "examinerContainer": [
        {
          "id": "examinerView",
          "name": "Course Catalog"
        }
      ]
    },
    "menus": {
      "view/title": [
        {
          "command": "trainingCatalogExaminer.startFromSelection",
          "when": "view == examinerView",
          "group": "navigation"
        }
      ]
    }
  }
}
```

**ОБЯЗАТЕЛЬНЫЕ команды**:
- `trainingCatalogExaminer.toggleCourse`
- `trainingCatalogExaminer.startFromSelection`

### ШАГ 3: Архитектура основного кода

**ВАЖНО**: Создать класс `CourseTreeItem` наследующий от `vscode.TreeItem`

**КЛЮЧЕВЫЕ СВОЙСТВА**:
- `checked: boolean` - состояние чекбокса
- `courseName: string` - имя курса
- `fullPath: string` - полный путь к папке

**КРИТИЧЕСКИ ВАЖНЫЙ МЕТОД**: `hasFiles(dirPath: string)`
```typescript
private hasFiles(dirPath: string): boolean {
    if (!fs.existsSync(dirPath)) return false;
    const items = fs.readdirSync(dirPath);
    return items.some(item => {
        const fullPath = path.join(dirPath, item);
        return fs.statSync(fullPath).isFile() || 
               (fs.statSync(fullPath).isDirectory() && this.hasFiles(fullPath));
    });
}
```

### ШАГ 4: Реализация Tree View Provider

**ОБЯЗАТЕЛЬНЫЕ МЕТОДЫ**:

1. `getChildren()` - читает папки из `Database/Courses/`
2. `getTreeItem()` - возвращает CourseTreeItem
3. `refresh()` - обновляет дерево

**КРИТИЧЕСКИ ВАЖНО**: В getChildren() НЕ создавать новые элементы, а обновлять существующие:

```typescript
// НЕ ТАК:
// return courses.map(course => new CourseTreeItem(...));

// ТАК:
const items = this.courseItems || [];
// обновляем существующие элементы
```

### ШАГ 5: Логика чекбоксов

**НИКОГДА НЕ ИСПОЛЬЗОВАТЬ**: `TreeItemCheckboxState` API

**ИСПОЛЬЗОВАТЬ**: Эмодзи в label:
- Не выбрано: `☐ ${courseName}`
- Выбрано: `☑️ ${courseName}`

**МЕТОД toggleCourse()**:
```typescript
item.checked = !item.checked;
item.label = item.checked ? `☑️ ${item.courseName}` : `☐ ${item.courseName}`;
this.onDidChangeTreeData.fire(item);
```

### ШАГ 8: Обработка пустых папок

**ПРАВИЛО**: Только папки с файлами должны иметь стрелочку раскрытия

```typescript
this.collapsibleState = this.hasFiles(fullPath) ? 
    vscode.TreeItemCollapsibleState.Collapsed : 
    vscode.TreeItemCollapsibleState.None;
```

### ШАГ 9: Управление состоянием экзамена

**ДОБАВИТЬ В КОД**: Логику обновления статуса файла

```typescript
// При новом выборе курсов
const newExamContent = `СТАТУС: НОВЫЙ_ВЫБОР\nВыбор пользователя для экзамена:\n${selectedCourses.join('\n')}\n\nВремя выбора: ${new Date()}\nГотов к началу экзамена!`;

// При добавлении курсов к активному экзамену
const updateContent = `СТАТУС: ОБНОВЛЕНИЕ_ВЫБОРА\nДобавлены курсы:\n${newCourses.join('\n')}\n\nВремя обновления: ${new Date()}`;
```

**ЦЕЛЬ**: Copilot сможет различать новый экзамен от добавления модулей к текущему.

### 4. Интеграция с Copilot

**МЕТОД**: Сохранение в файл `user-selection.txt` в корне workspace

**АВТОМАТИЧЕСКИЙ МЕХАНИЗМ COPILOT** (РЕАЛЬНОСТЬ):
- **ПРОБЛЕМА**: Copilot НЕ сканирует изменения файлов автоматически между сообщениями
- **РЕШЕНИЕ**: Пользователь должен явно упомянуть файл или использовать дополнительные механизмы

**РАБОЧИЕ ВАРИАНТЫ ИНТЕГРАЦИИ**:

**Вариант 1 - Явное упоминание**:
После выбора курсов пользователь пишет: "Прочитай user-selection.txt и начни экзамен"

**Вариант 2 - Копирование в чат**:
Расширение показывает текст в Output Channel с инструкцией: "Скопируйте это в чат Copilot"

**Вариант 3 - Уведомление**:
Расширение показывает уведомление: "Выбор сохранен в user-selection.txt. Напишите Copilot: 'Начни экзамен по выбранным курсам'"

**РЕКОМЕНДУЕМЫЙ ПОДХОД**: Комбинация - автоматическое создание файла + уведомление пользователю с готовым текстом для копирования в чат.

**ФОРМАТ ФАЙЛА**:
```
Выбор пользователя для экзамена:
[Курс 1]
[Курс 2]

Время выбора: [дата время]
Готов к началу экзамена!
```

**ПРИНЦИП РАБОТЫ ИНТЕГРАЦИИ**:
1. Пользователь выбирает курсы в расширении
2. Нажимает кнопку запуска экзамена
3. Создается файл user-selection.txt
4. Пользователь пишет ЛЮБОЕ сообщение в чат Copilot
5. Copilot АВТОМАТИЧЕСКИ читает файл и знает выбранные курсы
6. Экзамен начинается с учетом выбранного контента

**УПРАВЛЕНИЕ СОСТОЯНИЕМ ЭКЗАМЕНА**:

**ПРОБЛЕМА**: Как различить обычное общение во время экзамена от добавления новых модулей?

**РЕШЕНИЕ**: Формат файла с индикатором состояния:
```
СТАТУС: АКТИВНЫЙ_ЭКЗАМЕН
Выбор пользователя для экзамена:
[Курс 1]
[Курс 2]

Время выбора: [дата время]
Готов к началу экзамена!
```

**ЛОГИКА ОБНОВЛЕНИЯ**:
- При новом выборе курсов → СТАТУС: НОВЫЙ_ВЫБОР  
- После первого вопроса экзамена → СТАТУС: АКТИВНЫЙ_ЭКЗАМЕН
- При добавлении модулей во время экзамена → СТАТУС: ОБНОВЛЕНИЕ_ВЫБОРА

**ОБРАБОТКА COPILOT**:
- НОВЫЙ_ВЫБОР → начать новый экзамен
- АКТИВНЫЙ_ЭКЗАМЕН → продолжить текущий экзамен  
- ОБНОВЛЕНИЕ_ВЫБОРА → добавить модули к текущему экзамену

### ШАГ 8: Регистрация в extension.ts

**ОБЯЗАТЕЛЬНЫЕ РЕГИСТРАЦИИ**:
```typescript
vscode.commands.registerCommand('trainingCatalogExaminer.toggleCourse', ...);
vscode.commands.registerCommand('trainingCatalogExaminer.startFromSelection', ...);
vscode.window.createTreeView('examinerView', { treeDataProvider: provider });
```

### ШАГ 9: Критические ошибки, которых нужно избегать

**НИКОГДА НЕ ДЕЛАТЬ**:

1. **TreeItemCheckboxState API** - не работает, использовать эмодзи
2. **Полное пересоздание дерева** - вызывает дублирование элементов
3. **Синхронные операции в UI** - использовать правильные async/await паттерны
4. **Игнорирование пустых папок** - обязательно проверять hasFiles()
5. **Прямая отправка в Copilot chat** - API не поддерживает, использовать файл

### ШАГ 10: Последовательность разработки

**ПОРЯДОК РЕАЛИЗАЦИИ**:

1. Создать базовый package.json с Activity Bar
2. Создать простейший TreeDataProvider (без чекбоксов)
3. Добавить чтение папок из Database/Courses/
4. Реализовать эмодзи чекбоксы
5. Добавить команду toggleCourse
6. Реализовать сохранение в файл
7. Добавить кнопку запуска в заголовок
8. Протестировать интеграцию с Copilot

### ШАГ 11: Отладка и тестирование

**ОБЯЗАТЕЛЬНЫЕ ПРОВЕРКИ**:

1. Пустые папки не должны иметь стрелочек
2. Клик по чекбоксу должен менять эмодзи
3. Файл user-selection.txt должен создаваться при запуске
4. Copilot должен видеть содержимое файла в чате
5. Горячая клавиша Ctrl+Alt+E должна работать

### ШАГ 12: Структура файлов в результате

```
app/
├── extension.ts           # 150-200 строк кода
├── package.json          # ~100 строк конфигурации
├── tsconfig.json         # Стандартная конфигурация TypeScript
└── out/                  # Скомпилированные файлы

workspace_root/
├── Database/
│   └── Courses/          # Источник данных
├── user-selection.txt    # Создается автоматически
└── app/                  # Код расширения
```

## КЛЮЧЕВЫЕ ПРИНЦИПЫ РЕАЛИЗАЦИИ

### Принцип 1: Простота превыше всего
- Эмодзи вместо сложных API
- Файл вместо сложной интеграции
- Прямое обновление элементов вместо пересоздания

### Принцип 2: Совместимость с VS Code
- Использовать только проверенные API
- Следовать паттернам расширений VS Code
- Не полагаться на экспериментальные функции

### Принцип 3: Отказоустойчивость
- Проверять существование папок
- Graceful handling ошибок
- Информативные сообщения пользователю

### Принцип 4: Автоматическая интеграция с Copilot
- Файловый механизм обеспечивает автоматическое чтение контекста
- Пользователю не нужно дополнительных команд для передачи выбора
- Любое сообщение после создания файла автоматически включает контекст курсов
- Seamless UX - выбрал курсы, написал сообщение, получил экзамен

### ШАГ 13: Настройка автоматизированного развертывания

**СОЗДАТЬ СИСТЕМУ БЫСТРОГО ОБНОВЛЕНИЯ**:

1. **Установить VSCE** (если еще не установлен):
   ```bash
   npm install -g @vscode/vsce
   ```

2. **Создать скрипт автоматизации** (или использовать команды по очереди):
   - Упаковка: `vsce package --allow-missing-repository`
   - Удаление старой версии: `code --uninstall-extension fityro.training-catalog-examiner`
   - Установка новой: `code --install-extension training-catalog-examiner-0.0.1.vsix`

3. **Протестировать полный цикл** обновления расширения

**РЕЗУЛЬТАТ**: Система позволяет обновлять расширение за 10-15 секунд без ручного вмешательства.

## ФИНАЛЬНАЯ ПРОВЕРКА РАБОТОСПОСОБНОСТИ

**ЧЕК-ЛИСТ**:
- [ ] Расширение активируется через Ctrl+Alt+E
- [ ] В Activity Bar появляется иконка ▶
- [ ] Дерево показывает курсы из Database/Courses/
- [ ] Клик по курсу меняет ☐ на ☑️
- [ ] Кнопка ▶ в заголовке запускает экзамен
- [ ] Создается файл user-selection.txt
- [ ] **КРИТИЧЕСКИ ВАЖНО**: Любое сообщение в чат после создания файла автоматически вызывает у Copilot чтение контекста
- [ ] Пустые папки не имеют стрелочек раскрытия
- [ ] Экзамен проводится на основе выбранных курсов без дополнительных команд

---
*Этот алгоритм протестирован и гарантированно работает*  
*Дата создания: 2 ноября 2025*  
*Статус: Готов к репликации*